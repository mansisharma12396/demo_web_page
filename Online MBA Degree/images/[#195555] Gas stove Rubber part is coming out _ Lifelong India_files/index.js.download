!function(){"use strict";function t(t,n){var e,o=Object.keys(t);return Object.getOwnPropertySymbols&&(e=Object.getOwnPropertySymbols(t),n&&(e=e.filter(function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable})),o.push.apply(o,e)),o}function c(o){for(var n=1;n<arguments.length;n++){var i=null!=arguments[n]?arguments[n]:{};n%2?t(Object(i),!0).forEach(function(n){var t,e;t=o,e=i[n=n],n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(i)):t(Object(i)).forEach(function(n){Object.defineProperty(o,n,Object.getOwnPropertyDescriptor(i,n))})}return o}function n(n){var t=n.scriptContent,e=n.src,o=n.onLoad,n=n.crossOrigin,i=document.createElement("script");t&&(t=document.createTextNode(t),i.appendChild(t)),e&&(i.src=e),"function"==typeof o&&(i.onload=o),n&&(i.crossOrigin=n),document.body.appendChild(i)}function i(t,e){setTimeout(function(){var n;++D._currAttempt>D._maxAttempts?(g=l.RETRY_EXHAUSTED,n=c(c({},d),{},{status:g,reason:"domain validation retries exhausted"}),S(e,n)):y(p.model.session_token).then(function(){g=l.VALID,t()}).catch(function(n){n.status===l.FORBIDDEN?(g=l.FORBIDDEN,S(e,n)):i(t,e)})},1e3)}function r(n,t,e,o){v(n,t,e).then(function(n){p.emit(o,{success:!0,sessionId:n&&n.session_id||"",idleSecondsRemaining:n&&n.session_validity_in_seconds||"",idleSessionConfigured:n&&n.idle_session_timeout_in_seconds||0})}).catch(function(n){n.skip=403!==n.status,p.emit(o,n)})}var e,o,s,a,u,d,f,l,p,h,E,m,g,O,y,D,S,T,v,w,P,_,R,I,k,b,N,C,j,L,x,A;e=window,s=!1,a=function(){e.onSentryInit=function(){s=!0,delete e.onSentryInit,delete e.onSentryLoad},n({scriptContent:"\n    window.onSentryLoad = () => {\n      /** \n       * Add errors to ignore in the array\n       * below. It accepts 'strings' and 'regex'\n      */\n      var SENTRY_ERRORS_TO_IGNORE = [\n        // These errors are caused due to an unhandled rejection in\n        // Session Checker. Since we couldn't identify the root cause\n        // and it does not affect user's experience we are choosing to\n        // ignore it. Also it is observed only for few tens of users.\n        /\"CustomEvent\"/i,\n        /stopBlockQuote is not defined/i,\n        /jQuery is not defined/i,\n        /Non-Error promise rejection captured with keys: isTrusted/i\n      ]\n      if(window.Sentry) {\n        window.Sentry.init && window.Sentry.init({\n          dsn: window.TPS_CONFIG.SENTRY_DNS,\n          ignoreErrors: SENTRY_ERRORS_TO_IGNORE,\n        });\n        window.Sentry.configureScope && window.Sentry.configureScope(function (scope) {\n          scope.setTag('Context', 'Session Checker');\n        });\n      }\n      window.onSentryInit && window.onSentryInit();\n    };\n  "}),n({src:"https://browser.sentry-cdn.com/5.6.3/bundle.min.js",onLoad:function(){e.onSentryLoad()},crossOrigin:"anonymous"})},d={success:!(u=1e4)},f={GET:"GET",POST:"POST"},l={VALID:200,FORBIDDEN:403,NO_TOKEN:-1,RETRY_EXHAUSTED:-5},h=p=null,E=e.location.origin,g=m=null,O="".concat(E,"/api/v2/session"),y=function(n){return T(f.POST,"/api/v2/session/validate",{session_token:n})},D={_currAttempt:0,_maxAttempts:5},S=function(n,t){t=c(c({},d),t);n(t),console.error(t)},e.onload=function(){new Postmate.Model({initSessionChecker:function(n){var t=n.httpMethod,e=n.apiEndPoint,o=n.sessionToken,i=n.payload,r=n.checkSessionOnlyOnce,s=n.successListener,n=n.errorListener,t=t||f.POST;x(t,e,i||{session_token:o},r,s||"sessionData",n||"sessionDataError")},clearSessionChecker:function(){clearInterval(h),h=null},initUserIncludesProducts:function(n){n=n.apiEndPoint;w(n)},initProducts:function(n){n=n.apiEndPoint;_(n)},initBundles:function(n){n=n.apiEndPoint;R(n)},getCloudTypes:function(n){n=n.apiEndPoint;I(n)},getOrgBundles:function(n){n=n.apiEndPoint;k(n)},iniOrganisation:function(n){n=n.apiEndPoint;P(n)},trackSessionChecker:function(n){n.name,n.properties},initRefreshToken:function(n){n=n.apiEndPoint;b(n)},getOrgConfig:function(){N()},getRtsContext:function(n){var t=n.apiEndPoint,n=n.sessionToken;C(t,n)},extendSession:function(n){var t=n.apiEndPoint,n=n.sessionToken;j(t,n)},sessionInvalidate:function(n){var t=n.apiEndPoint,n=n.sessionToken;L(t,n)},makeRequest:function(n){var t=n.httpMethod,e=n.apiEndPoint,o=n.payload,i=n.successListener,r=n.errorListener;v(t,e,void 0===o?{}:o).then(function(n){p.emit(i,n)}).catch(function(n){p.emit(r,n)})}}).then(function(n){if(!(n=p=n)||!n.model||!("string"==typeof(n=n.model.session_token)&&0<n.length&&"true"!==n)){g=l.NO_TOKEN;try{new URL(document.referrer).origin===E&&(g=l.VALID),A()}catch(n){console.error("unable to validate referrer's origin ",n)}}else o=p.model.session_token,(m=new Promise(function(t,e){y(o).then(function(){g=l.VALID,t()}).catch(function(n){n.status===l.FORBIDDEN?(g=l.FORBIDDEN,S(e,n)):i(t,e)})})).then(function(){A()}).catch(function(n){console.error("domain validation failed ",n)});var o}).catch(function(n){console.error("Error initiating handshake with parent.",n)})},T=function(i,r){var s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return new Promise(function(t,e){var o=new XMLHttpRequest,n=(o.onreadystatechange=function(){try{var n;4===o.readyState&&(200<=o.status&&o.status<300?(n=JSON.parse(o.responseText),t(n)):e(c(c({},d),{},{status:o.status})))}catch(n){e(d)}},null);f.POST===i&&(n=JSON.stringify(s)),o.open(i,r),o.withCredentials=!0,o.setRequestHeader("content-type","application/json"),o.timeout=u,o.send(n)})},v=function(){for(var n=arguments.length,o=new Array(n),t=0;t<n;t++)o[t]=arguments[t];return new Promise(function(t,e){g===l.NO_TOKEN?S(e,{status:l.FORBIDDEN,reason:"no session token provided"}):g===l.FORBIDDEN?S(e,{status:l.FORBIDDEN,reason:"invalid session token set by host"}):g===l.VALID?T.apply(void 0,o).then(function(n){return t(n)}).catch(function(n){return e(n)}):g===l.RETRY_EXHAUSTED&&o[1]===O?T.apply(void 0,o).then(function(n){return t(n)}).catch(function(n){return e(n)}):m.then(function(){T.apply(void 0,o).then(function(n){return t(n)}).catch(function(n){return e(n)})}).catch(function(n){g=n.status,S(e,n)})})},w=function(n){v(f.GET,n).then(function(t){t&&t.user&&t.user.id&&!!s&&e.Sentry&&e.Sentry.configureScope&&e.Sentry.configureScope(function(n){n.setUser({id:t.user.id})}),p.emit("userIncludesProductsData",t)}).catch(function(n){p.emit("userIncludesProductsDataError",n)})},P=function(n){v(f.GET,n).then(function(n){p.emit("organisationData",n)}).catch(function(n){p.emit("organisationDataError",n)})},_=function(n){v(f.GET,n).then(function(n){p.emit("productsData",n)}).catch(function(n){p.emit("productsDataError",n)})},R=function(n){v(f.GET,n).then(function(n){p.emit("bundlesData",n)}).catch(function(n){p.emit("bundlesDataError",n)})},I=function(n){v(f.GET,n).then(function(n){p.emit("cloudTypesData",n)}).catch(function(n){p.emit("cloudTypesDataError",n)})},k=function(n){v(f.GET,n).then(function(n){p.emit("orgBundlesData",n)}).catch(function(n){p.emit("orgBundlesDataError",n)})},b=function(n){v(f.GET,n).then(function(n){p.emit("refreshTokenData",n)}).catch(function(n){p.emit("refreshTokenDataError",n)})},N=function(){o.then(function(n){p.emit("orgConfigData",n)}).catch(function(n){p.emit("orgConfigDataError",n)})},C=function(n,t){v(f.POST,n,{session_token:t}).then(function(n){p.emit("rtsContextData",n)}).catch(function(n){p.emit("rtsContextDataError",n)})},j=function(n,t){v(f.POST,n,{session_token:t}).then(function(n){p.emit("sessionExtendData",n)}).catch(function(n){p.emit("sessionExtendDataError",n)})},L=function(n,t){v(f.POST,n,{session_token:t}).then(function(n){p.emit("sessionInvalidateData",n)}).catch(function(n){p.emit("sessionInvalidateDataError",n)})},x=function(n,t,e){var o=3<arguments.length&&void 0!==arguments[3]&&arguments[3],i=4<arguments.length?arguments[4]:void 0;r(n,t,e,i),o||null===h&&(h=setInterval(function(){r(n,t,e,i)},1e4))},A=function(){(o=v(f.GET,"/api/v2/organisations/-/appInitPayload")).then(function(n){return!!n&&!!n.organisation_config&&!!n.organisation_config.tps_disabled}).catch(function(n){return!0}).then(function(n){n||a()})}}();
